---
title: "Criando o R Markdown da atividade 3"
author: "Nilson Berriel"
date: "03/10/2021"
output: html_document
---

A espécie escolhida para esta atividade foi a <font color = green>*Metrodorea nigra* A.St.-Hil.</font>. Uma espécie arbórea, decídua, endêmica do Brasil e de ocorrência registrada entre os estados do Maranhão e Paraná, contudo mais associada a Mata Atlântica (Flora do Brasil, 2021). [^1]

[^1]: Pirani, J.R.; Groppo, M. 2020. Rutaceae in Flora do Brasil 2020. Jardim Botânico do Rio de Janeiro.Disponível em: <http://reflora.jbrj.gov.br/reflora/floradobrasil/FB819>. Acesso em: 03 out. 2021

![Distribuição da *M. nigra*](C:/R/ciencolab_banco-dados/cienc.colab/cienc.colab/mapa_m_nigra.jpg)


Vamos carregar os pacotes que serão utilizados: ``tidyverse``, ``rgbif``

```{r pacotes 1, echo=FALSE}
library(tidyverse)
library(rgbif)
library(magrittr)

#warning=FALSE, message=FALSE
```

A seguir, vamos utilizar a função `occ_data`, disponível no pacote `rgbif`, para selecionar os dados da *M. nigra* que serão utilizados.

```{r}
M.nigra_gbif <- occ_data(scientificName = "Metrodorea nigra", 
                      hasCoordinate = TRUE,
                      hasGeospatialIssue=FALSE)
```

Agora vamos checar as dimenões dos dados encontrados:

```{r}
dim(M.nigra_gbif$data)
```

Aqui vamos checar os campos de dados disponíveis para a espécie e assim selecionar as mais adequadas.
```{r}
M.nigra_gbif$data %>% names
```

Desta forma iremos criar um novo objeto com os campos de maior interesse para a *M. nigra*.

```{r}
M.nigra_gbif1 <- M.nigra_gbif$data %>%
  dplyr::select(scientificName, acceptedScientificName, decimalLatitude, decimalLongitude,
                issues,elevation, basisOfRecord, occurrenceStatus, rightsHolder, 
                datasetName, recordedBy, locality, stateProvince,county, habitat) 

M.nigra_gbif1
```


Precisamos checar os problemas que são suspeitos de conter erros mais aparentes. Por se tratar de uma espécie arbórea, vamos inicialmente checar o habitat.

```{r}
M.nigra_gbif1 %>%
  distinct(habitat) %>%
  pull()
```

```{r}
M.nigra_gbif1 %>%
  group_by(habitat) %>% 
  summarise(occ = length(scientificName)) %>% 
  ggplot(aes(occ, y=habitat)) +
  geom_bar(stat = 'identity') 
```

```{r}
# fonte na coleção de madeira
M.nigra_gbif1 %>% 
  filter(habitat %in% c("ColeÃ§ao de madeira.")) %>% 
  distinct(datasetName)
```


```{r}
M.nigra_gbif1 %>% 
  filter(datasetName %in% c("Vascular plants"))
```


```{r}
# filtrar todas do dataset suspeito
M.nigra_gbif_ok <- M.nigra_gbif1 %>% 
  filter(!datasetName %in% c("Vascular plants"))
```

```{r}
#checando #rever o filtro q fiz, acredito q deu errado

M.nigra_gbif_ok %>%
  group_by(habitat) %>% 
  summarise(occ = length(scientificName)) %>% 
  ggplot(aes(occ, y=habitat)) +
  geom_bar(stat = 'identity') 
```

Carregando mais pacotes para a atividade
```{r}
library(ggmap)
library(maps)
library(mapdata)
```

```{r}
brasil <- map_data('world',region="Brazil")

```



```{r}
 #checar pontos

ggplot() +
  geom_polygon(data = brasil, aes(x = long, y = lat, group = group)) +
  coord_fixed() +
  theme_classic() +
  geom_point(data = M.nigra_gbif_ok, aes(x = decimalLongitude, y = decimalLatitude), color = "red") +
  labs(x = "longitude", y = "latitude", title = expression(italic("Metrodorea nigra")))
```

usando as funções q estão na parte OBIS da atividade

```{r}
library(CoordinateCleaner)
#library(obistools)
#library(scrubr)
library(biogeo)
```

```{r função flag outlier}
flag_outlier <- function(df, species){
  
  # funcao para classificar ocorrencias suspeitas
  # baseada no calculo do centroide de todas ocorrencias
  # indica como 'check' as ocorrencias que tem distancias até o centroide
  # acima do 90th quantil (default) das distancias calculadas
  
  dados <- df %>% 
    dplyr::filter(scientificName == species); 
  
  dados2 <- geosphere::distVincentyEllipsoid(
    dados %>%
      summarise(centr_lon = median(decimalLongitude),
                centr_lat = median(decimalLatitude)),
    dados %>% 
      dplyr::select(decimalLongitude, decimalLatitude)
  ) %>% 
    bind_cols(dados) %>% 
    rename(dist_centroid = '...1') %>% 
    mutate(flag = ifelse(dist_centroid < quantile(dist_centroid, probs = 0.9), "OK",
                         ifelse(dist_centroid >= quantile(dist_centroid, probs = 0.90) & dist_centroid < quantile(dist_centroid, probs = 0.95), "check > Q90",
                                ifelse(dist_centroid >= quantile(dist_centroid, probs = 0.95), "check > Q95", "OK"))))
  
    # mutate(flag = ifelse(dist_centroid > quantile(dist_centroid, probs = prob), "check", "OK"))
  
  print(dados2)
  
}

```


```{r}
 marcados <- M.nigra_gbif$data %>% 
  data.frame() %>% 
  dplyr::select(scientificName, decimalLongitude, decimalLatitude, datasetName) %>% 
  distinct() %>% 
  flag_outlier(., "Metrodorea nigra A.St.-Hil.")

```



```{r}
# mapa
ggplot() +
  geom_polygon(data = brasil, aes(x = long, y = lat, group = group)) +
  coord_fixed() +
  theme_classic() +
  geom_point(data = marcados, 
             aes(x = decimalLongitude, y = decimalLatitude, 
                 color = flag)) +
  theme(legend.title = element_blank()) +
  labs(x = "longitude", y = "latitude", 
       title = expression(italic("Metrodorea nigra")))
```




